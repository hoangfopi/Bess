<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Web App</title>
</head>
<body>
    <h1>与 Gemini 对话</h1>
    <textarea id="prompt" placeholder="在此输入您的问题..."></textarea>
    <button onclick="fetchData()">发送</button>
    <pre id="response"></pre>

    <script>
        async function fetchData() {
            const promptInput = document.getElementById('prompt').value;
            const responseContainer = document.getElementById('response');
            responseContainer.textContent = '正在获取信息...';

            try {
                const response = await fetch('/.netlify/functions/get-gemini-data', {
                    method: 'POST',
                    body: JSON.stringify({ prompt: promptInput }),
                });

                if (!response.ok) {
                    throw new Error('网络响应错误');
                }

                const data = await response.json();

                // 提取并显示 Gemini 的回复
                const geminiText = data.candidates[0].content.parts[0].text;
                responseContainer.textContent = geminiText;

            } catch (error) {
                responseContainer.textContent = `发生错误: ${error.message}`;
            }
        }
    </script>
</body>
</html>




<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欧洲储能市场每日洞察</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">欧洲储能市场每日洞察</h1>
            <p id="news-date" class="text-md text-gray-500 mt-2">获取前一日最有价值的行业资讯</p>
        </header>

        <!-- Action Button -->
        <div class="text-center mb-8">
            <button id="get-news-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                获取最新资讯
            </button>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loader" class="hidden justify-center items-center my-8">
            <div class="loader"></div>
            <p class="ml-4 text-gray-600">正在为您生成最新资讯摘要...</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative text-center" role="alert">
            <strong class="font-bold">发生错误！</strong>
            <span class="block sm:inline">无法获取资讯，请稍后重试。</span>
        </div>

        <!-- News Container -->
        <main id="news-container" class="space-y-6"></main>
    </div>

    <script>
        const getNewsBtn = document.getElementById('get-news-btn');
        const newsContainer = document.getElementById('news-container');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const newsDateEl = document.getElementById('news-date');

        getNewsBtn.addEventListener('click', fetchNews);

        // Set and display the current date
        const today = new Date();
        const formattedDate = `${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日`;
        newsDateEl.textContent = `今天是 ${formattedDate}。为您呈现前一日的市场精华资讯。`;

        async function fetchNews() {
            newsContainer.innerHTML = '';
            errorMessage.classList.add('hidden');
            loader.style.display = 'flex';
            getNewsBtn.disabled = true;
            getNewsBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // Switched back to a text prompt that requests a raw JSON string.
                // This method is often more robust than using responseSchema for complex queries.
                const userPrompt = `
                    You are an expert analyst for the European BESS market. Your task is to find the top 10 most significant updates from yesterday.
                    
                    Instructions:
                    1.  Scan reputable online sources: major news sites, industry forums (e.g., Reddit), and professional social media discussions.
                    2.  Identify up to 10 of the most valuable items related to the European BESS market (technology, policy, projects, finance).
                    3.  Generate a response in the format of a single, raw JSON object string.
                    
                    JSON Structure Rules:
                    - The root must be an object with one key: "news_items".
                    - "news_items" must be an array of objects.
                    - Each object in the array must have four keys:
                        - "headline": (string) The title, in Chinese.
                        - "summary": (string) A concise summary in Chinese, under 200 characters.
                        - "sourceName": (string) The name of the source (e.g., 'Reuters', 'Reddit r/Energy').
                        - "sourceUrl": (string) The full, direct URL to the source article or post.

                    CRITICAL: Your entire output must be ONLY the JSON object string, starting with '{' and ending with '}'. Do not include any text, explanations, or markdown like \`\`\`json.
                `;

                const apiKey = ""; // API key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    tools: [{"google_search": {}}]
                    // Removed generationConfig with responseSchema for better stability
                };

                // Exponential backoff for retries
                let response;
                let attempts = 0;
                const maxAttempts = 5;

                while (attempts < maxAttempts) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) break;
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Server error: ${response.status}`);
                        }

                        let errorDetails = `Received status code ${response.status}`;
                        try {
                            const errorBody = await response.json();
                            errorDetails = errorBody.error?.message || JSON.stringify(errorBody);
                        } catch (e) {
                            errorDetails = response.statusText || 'Unknown client error';
                        }
                        const finalError = new Error(`API Error: ${errorDetails}`);
                        finalError.isFinal = true;
                        throw finalError;

                    } catch (error) {
                        if (error.isFinal) throw error;
                        attempts++;
                        if (attempts >= maxAttempts) {
                            throw new Error(`Request failed after ${maxAttempts} attempts: ${error.message}`);
                        }
                        const delay = Math.pow(2, attempts) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                if (!response || !response.ok) {
                    throw new Error('Failed to fetch news after several retries.');
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let responseText = candidate.content.parts[0].text;
                    
                    // Clean the response text in case the model wraps it in markdown
                    responseText = responseText.replace(/^```json\s*/, '').replace(/```$/, '').trim();

                    try {
                        const parsedJson = JSON.parse(responseText);
                        displayNews(parsedJson.news_items);
                    } catch (parseError) {
                        console.error("Failed to parse JSON response:", responseText);
                        throw new Error("AI模型返回了无效的格式。");
                    }
                } else {
                    console.error("Invalid response structure:", result);
                    if (result?.promptFeedback?.blockReason) {
                         throw new Error(`请求被阻止：${result.promptFeedback.blockReason}`);
                    }
                    throw new Error("未能从AI模型获取有效的新闻内容。");
                }

            } catch (error) {
                console.error('Error fetching news:', error);
                const errorMessageSpan = errorMessage.querySelector('span');
                if (errorMessageSpan) {
                    errorMessageSpan.textContent = `无法加载资讯：${error.message}。请检查您的网络连接或稍后再试。`;
                }
                errorMessage.classList.remove('hidden');
            } finally {
                loader.style.display = 'none';
                getNewsBtn.disabled = false;
                getNewsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function displayNews(newsItems) {
            if (!newsItems || newsItems.length === 0) {
                newsContainer.innerHTML = `<p class="text-center text-gray-500">今日暂无重要资讯。</p>`;
                return;
            }

            newsItems.forEach((item, index) => {
                const card = document.createElement('article');
                card.className = 'card p-6';
                card.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-100 text-blue-600 font-bold rounded-full flex items-center justify-center text-lg">
                            ${index + 1}
                        </div>
                        <div class="flex-grow">
                            <h2 class="text-lg md:text-xl font-bold text-gray-900 mb-2">${item.headline}</h2>
                            <p class="text-gray-600 text-base leading-relaxed">${item.summary}</p>
                            <div class="mt-4 text-sm text-gray-500">
                                <span>来源：</span>
                                <a href="${item.sourceUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                    ${item.sourceName || '未知来源'}
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                newsContainer.appendChild(card);
            });
        }
        
        // Automatically fetch news on page load
        window.onload = () => {
             getNewsBtn.click();
        };

    </script>
</body>
</html>



